<!DOCTYPE html>
<html lang="en">

{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}?version=1">

<script src="https://code.highcharts.com/highcharts.src.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
        crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>

<script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js "></script>
<script src=" https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src=" https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src=" https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src=" https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
<script src=" https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>


<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="alert alert-warning">
                <div class="icon hidden-xs " style="background-color: #c82630">
                    <svg style=" width: 30px; color: white;" aria-hidden="true" focusable="false"
                         data-prefix="fas" data-icon="exclamation-triangle" role="img"
                         xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"
                         class="svg-inline--fa fa-exclamation-triangle fa-w-18">
                        <path fill="currentColor"
                              d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"
                              class=""></path>
                    </svg>
                </div>
                <strong>Warning</strong>
                <Br/> Al-adha eid is comming!, and a noticeable increase in infection is expected, take care of
                your health
            </div>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4>Daily Confirmed Cases/ Forecast</h4>
                </div>
                <div class="card-body">


                    <div id="container" style="width:100%; height:400px;"></div>
                    <table id="conf-table" class="display table table-striped table-bordered" style="width:100%">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Date</th>
                            <th scope="col">Forecasted New Confirmed Case</th>

                        </tr>
                        </thead>
                        <tbody id="confirmed-cases">


                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4>Daily Death/ Forecast</h4>
                </div>
                <div class="card-body">
                    <div id="container2" style="width:100%; height:400px;"></div>
                    <table id="death-table" class="display table table-striped table-bordered" style="width:100%">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Date</th>
                            <th scope="col">Forecasted New Death Case</th>

                        </tr>
                        </thead>
                        <tbody id="death-cases">


                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4>Daily Recovered/ Forecast</h4>
                </div>

            </div>
        </div>
    </div>
</div>


</body>
</html>
<script>
    $(document).ready(function () {

        $('.buttons-csv').addClass('btn-primary')
        $('#conf-table').DataTable(
            {
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
            }
        );
        $('#death-table').DataTable(
            {
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
            }
        );
    });


    $.fn.dataTable.Buttons.defaults.dom.button.className = 'btn btn-primary mtb-5';


    //functions to get forecast
    function getPrediction() {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", 'http://127.0.0.1:8000/forecastConfirmedCases/', false); // false for synchronous request
        xmlHttp.send(null);
        return JSON.parse(xmlHttp.response);
    }

    //-------------------------


    //function to get actual data
    function getActualConfirmed() {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", 'http://127.0.0.1:8000/getActualConfirmed/', false); // false for synchronous request
        xmlHttp.send(null);
        return JSON.parse(xmlHttp.response);
    }

    function getActualRecovered() {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", 'http://127.0.0.1:8000/getActualRecovered/', false); // false for synchronous request
        xmlHttp.send(null);
        return JSON.parse(xmlHttp.response);
    }

    function getActualDeath() {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", 'http://127.0.0.1:8000/getActualDeath/', false); // false for synchronous request
        xmlHttp.send(null);
        return JSON.parse(xmlHttp.response);
    }

    // ----------------------- //
    //functions to construct graphs

    function constructConfirmedGraph() {
        predictedDate = getPrediction()
        var confirmedPrediction = []
        var deathPredcition = []
        for (let i = 0; i < predictedDate['date'].length; i++) {
            confirmedPrediction.push([new Date(predictedDate['date'][i]).getTime(), predictedDate['forecast-confirmed'][i]])
            deathPredcition.push([new Date(predictedDate['date'][i]).getTime(), 6.74423 + predictedDate['forecast-confirmed'][i] * 0.0451])
        }
        confirmedActual = parseDate(getActualConfirmed(), 'date', 'confirmed')
        Highcharts.chart('container', configGraph(confirmedActual, '#ff8f00', confirmedPrediction, '#007f05'));
        populateForecastingTable(confirmedPrediction, '#confirmed-cases')
        constructDeathGraph(deathPredcition)
    }

    function constructDeathGraph(dethPrediction) {
        var deathActual = parseDate(getActualDeath(), 'date', 'death')
        Highcharts.chart('container2', configGraph(deathActual, '#db0000', dethPrediction, '#280000'));
        populateForecastingTable(dethPrediction, "#death-cases")
    }

    function parseDate(wholeData, dateAttr = "date", metric) {
        parsedDate = []
        for (let i = 0; i < wholeData[dateAttr].length; i++) {
            parsedDate.push([new Date(wholeData[dateAttr][i]).getTime(), wholeData[metric][i]])
        }
        return parsedDate
    }

    function configGraph(actualData, ActualDataSerierscolor, PredictionData, PredictionDataDataSerierscolor) {
        config = {
            tooltip: {
                xDateFormat: '%d/%m/%Y',
                shared: true,
                split: true,
                enabled: true
            },
            chart: {
                type: 'line',
                zoomType: 'x'
            },
            title: {
                text: 'Number of Egypt Death Confirmed Cases \n & Predicted Death'
            },
            subtitle: {
                text: 'Source: Johns Hopkins University'
            },
            yAxis: {
                title: {
                    text: 'Death Cases'
                }
            },
            xAxis: {
                type: 'datetime',
                plotLines: [{
                    color: '#181414',
                    width: 2,
                    value: PredictionData[0][0],
                    dashStyle: 'ShortDot'
                }]
            },
            legend: {
                layout: 'horizontal',
                align: 'center',
                verticalAlign: 'bottom',
                x: 0,
                y: 0
            },
            series: [{
                name: "Actual Death Cases",
                data: actualData,
                color: ActualDataSerierscolor,
            },
                {
                    name: "Forecast Death Cases",
                    data: PredictionData,
                    dashStyle: 'longdash',
                    color: PredictionDataDataSerierscolor
                }]
            , plotOptions: {
                series: {
                    compare: 'percent',
                    showInNavigator: true,
                    dataGrouping: {
                        enabled: false
                    },
                }
            },
        }
        return config
    }

    function populateForecastingTable(predictedDate, tableClassName) {
        for (let i = 0; i < predictedDate.length; i++) {
            tableRow = document.createElement('tr')
            CounterData = document.createElement('td')
            dateData = document.createElement('td')
            newConfirmedData = document.createElement('td')
            CounterData.append(i + 1)
            date = new Date (predictedDate[i][0])
            dateData.append(date.getDate(),'/',date.getMonth(),'/',date.getFullYear())
            newConfirmedData.append(Math.ceil(predictedDate[i][1]))
            tableRow.append(CounterData)
            tableRow.append(dateData)
            tableRow.append(newConfirmedData)
            $(tableClassName).prepend(tableRow)
        }
    }




    constructConfirmedGraph()


</script>